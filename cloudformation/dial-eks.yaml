AWSTemplateFormatVersion: '2010-09-09'
Description: 'DIAL EKS Cluster with OIDC provider'

Parameters:
  ClusterName:
    Type: String
  
  KubernetesVersion:
    Type: String
    Default: '1.35'
  
  VPCId:
    Type: String
  
  PrivateSubnet1Id:
    Type: String
  
  PrivateSubnet2Id:
    Type: String
  
  EKSSecurityGroupId:
    Type: String
  
  PrivateRouteTableId:
    Type: String
    Description: Private route table ID for S3 Gateway endpoint

  # Managed node groups (3 groups: core / rag / dynamic)
  CoreNodeInstanceType:
    Type: String
    Default: 'c6i.xlarge'
    Description: 'EC2 instance type for core node group (recommended: 4 vCPU / 8 GiB)'

  CoreNodeMinSize:
    Type: Number
    Default: 1

  CoreNodeMaxSize:
    Type: Number
    Default: 1

  CoreNodeDesiredSize:
    Type: Number
    Default: 1

  RagNodeInstanceType:
    Type: String
    Default: 'c6i.xlarge'
    Description: 'EC2 instance type for RAG node group (recommended: 4 vCPU / 8 GiB)'

  RagNodeMinSize:
    Type: Number
    Default: 1

  RagNodeMaxSize:
    Type: Number
    Default: 1

  RagNodeDesiredSize:
    Type: Number
    Default: 1

  DynamicNodeInstanceType:
    Type: String
    Default: 'c6i.large'
    Description: 'EC2 instance type for dynamic workers node group (recommended: 2 vCPU / 4 GiB)'

  DynamicNodeMinSize:
    Type: Number
    Default: 2

  DynamicNodeMaxSize:
    Type: Number
    Default: 2

  DynamicNodeDesiredSize:
    Type: Number
    Default: 2

  SystemNodeInstanceType:
    Type: String
    Default: 'c6i.large'
    Description: 'EC2 instance type for system node group (recommended: 2 vCPU / 4 GiB)'

  SystemNodeMinSize:
    Type: Number
    Default: 1

  SystemNodeMaxSize:
    Type: Number
    Default: 1

  SystemNodeDesiredSize:
    Type: Number
    Default: 1

Resources:
  # VPC Endpoints Security Group
  VPCESecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC Endpoints (EKS requirements)
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.0.0.0/8
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-vpce-sg'

  # Required VPC Endpoints for EKS (air-gapped)
  EC2Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  ECRApiEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ecr.api'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  ECRDkrEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ecr.dkr'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  S3Endpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.s3'
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTableId

  STSEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.sts'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  EKSVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.eks'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  ELBVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.elasticloadbalancing'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  CognitoIdpVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPCId
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.cognito-idp'
      VpcEndpointType: Interface
      PrivateDnsEnabled: true
      SubnetIds:
        - !Ref PrivateSubnet2Id
      SecurityGroupIds:
        - !Ref VPCESecurityGroup

  # EKS Cluster IAM Role
  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ClusterName}-cluster-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: eks.amazonaws.com
            Action:
              - 'sts:AssumeRole'
              - 'sts:TagSession'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonEKSClusterPolicy'
        - 'arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly'
        - 'arn:aws:iam::aws:policy/AmazonEKSComputePolicy'
        - 'arn:aws:iam::aws:policy/AmazonEKSBlockStoragePolicy'
        - 'arn:aws:iam::aws:policy/AmazonEKSLoadBalancingPolicy'
        - 'arn:aws:iam::aws:policy/AmazonEKSNetworkingPolicy'
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-cluster-role'

  # EKS Node IAM Role
  EKSNodeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ClusterName}-node-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy'
        - 'arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy'
        - 'arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly'
        # AWS-managed policy for the EBS CSI driver uses the service-role path.
        - 'arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy'
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-node-role'

  # EKS Cluster
  EKSCluster:
    Type: AWS::EKS::Cluster
    DependsOn:
      - EC2Endpoint
      - ECRApiEndpoint
      - ECRDkrEndpoint
      - S3Endpoint
      - STSEndpoint
      - EKSVPCEndpoint
      - ELBVPCEndpoint
      - CognitoIdpVPCEndpoint
    Properties:
      Name: !Ref ClusterName
      Version: !Ref KubernetesVersion
      RoleArn: !GetAtt EKSClusterRole.Arn
      AccessConfig:
        AuthenticationMode: API
      KubernetesNetworkConfig:
        ServiceIpv4Cidr: 172.20.0.0/16
        IpFamily: ipv4
        ElasticLoadBalancing:
          Enabled: true
      ResourcesVpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1Id
          - !Ref PrivateSubnet2Id
        EndpointPrivateAccess: true
        EndpointPublicAccess: true
      Logging:
        ClusterLogging:
          EnabledTypes:
            - Type: api
            - Type: audit
            - Type: authenticator
            - Type: controllerManager
            - Type: scheduler
      Tags:
        - Key: Name
          Value: !Ref ClusterName

  # Managed node groups
  CoreNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSCluster
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Sub '${ClusterName}-core'
      NodeRole: !GetAtt EKSNodeRole.Arn
      Subnets:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      CapacityType: ON_DEMAND
      InstanceTypes:
        - !Ref CoreNodeInstanceType
      ScalingConfig:
        MinSize: !Ref CoreNodeMinSize
        MaxSize: !Ref CoreNodeMaxSize
        DesiredSize: !Ref CoreNodeDesiredSize
      Labels:
        workload: core

  RagNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSCluster
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Sub '${ClusterName}-rag'
      NodeRole: !GetAtt EKSNodeRole.Arn
      Subnets:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      CapacityType: ON_DEMAND
      InstanceTypes:
        - !Ref RagNodeInstanceType
      ScalingConfig:
        MinSize: !Ref RagNodeMinSize
        MaxSize: !Ref RagNodeMaxSize
        DesiredSize: !Ref RagNodeDesiredSize
      Labels:
        workload: rag
      Taints:
        - Key: dedicated
          Value: rag
          Effect: NO_SCHEDULE

  DynamicNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSCluster
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Sub '${ClusterName}-dynamic'
      NodeRole: !GetAtt EKSNodeRole.Arn
      Subnets:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      CapacityType: ON_DEMAND
      InstanceTypes:
        - !Ref DynamicNodeInstanceType
      ScalingConfig:
        MinSize: !Ref DynamicNodeMinSize
        MaxSize: !Ref DynamicNodeMaxSize
        DesiredSize: !Ref DynamicNodeDesiredSize
      Labels:
        workload: dynamic
      Taints:
        - Key: dedicated
          Value: dynamic
          Effect: NO_SCHEDULE

  SystemNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn: EKSCluster
    Properties:
      ClusterName: !Ref ClusterName
      NodegroupName: !Sub '${ClusterName}-system'
      NodeRole: !GetAtt EKSNodeRole.Arn
      Subnets:
        - !Ref PrivateSubnet1Id
        - !Ref PrivateSubnet2Id
      CapacityType: ON_DEMAND
      InstanceTypes:
        - !Ref SystemNodeInstanceType
      ScalingConfig:
        MinSize: !Ref SystemNodeMinSize
        MaxSize: !Ref SystemNodeMaxSize
        DesiredSize: !Ref SystemNodeDesiredSize
      Labels:
        workload: system
      Taints:
        - Key: dedicated
          Value: system
          Effect: NO_SCHEDULE

  # OIDC Provider
  OIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      Url: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        # EKS OIDC thumbprint - valid for all regions
        - '9e99a48a9960b14926bb7f3b02e22da2b0ab7280'
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-oidc-provider'

  # IAM role for aws-ebs-csi-driver controller (IRSA).
  # Nodes are configured with IMDS hop limit=1 (pods can't reach IMDS), so the controller
  # must use IRSA (ServiceAccountRoleArn on the EKS addon) to call AWS APIs.
  EBSCSIDriverRole:
    Type: AWS::IAM::Role
    DependsOn: OIDCProvider
    Properties:
      RoleName: !Sub '${ClusterName}-ebs-csi-driver-role'
      # IAM API expects this as a JSON string. Supplying a string here avoids
      # CloudFormation limitations around using intrinsic functions as map keys.
      AssumeRolePolicyDocument: !Sub
        - |
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": { "Federated": "${OIDCProviderArn}" },
                "Action": "sts:AssumeRoleWithWebIdentity",
                "Condition": {
                  "StringEquals": {
                    "${OIDCIssuer}:aud": "sts.amazonaws.com",
                    "${OIDCIssuer}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"
                  }
                }
              }
            ]
          }
        - OIDCProviderArn: !GetAtt OIDCProvider.Arn
          OIDCIssuer: !Select [1, !Split ['https://', !GetAtt EKSCluster.OpenIdConnectIssuerUrl]]
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy'
      Tags:
        - Key: Name
          Value: !Sub '${ClusterName}-ebs-csi-driver-role'

  # Optional: match dial-poc baseline addons (managed by EKS)
  PodIdentityAgentAddon:
    Type: AWS::EKS::Addon
    DependsOn: SystemNodeGroup
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: eks-pod-identity-agent
      ResolveConflicts: OVERWRITE

  EBSCSIDriverAddon:
    Type: AWS::EKS::Addon
    DependsOn:
      - SystemNodeGroup
      - EBSCSIDriverRole
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: aws-ebs-csi-driver
      ResolveConflicts: OVERWRITE
      ServiceAccountRoleArn: !GetAtt EBSCSIDriverRole.Arn
      ConfigurationValues: |
        controller:
          nodeSelector:
            workload: system
          tolerations:
            - key: dedicated
              operator: Equal
              value: system
              effect: NoSchedule
  
  MetricsServerAddon:
    Type: AWS::EKS::Addon
    DependsOn: SystemNodeGroup
    Properties:
      ClusterName: !Ref ClusterName
      AddonName: metrics-server
      ResolveConflicts: OVERWRITE
      ConfigurationValues: |
        nodeSelector:
          workload: system
        tolerations:
          - key: dedicated
            operator: Equal
            value: system
            effect: NoSchedule

Outputs:
  ClusterName:
    Description: EKS Cluster Name
    Value: !Ref ClusterName
    Export:
      Name: !Sub '${AWS::StackName}-ClusterName'

  ClusterArn:
    Description: EKS Cluster ARN
    Value: !GetAtt EKSCluster.Arn

  ClusterEndpoint:
    Description: EKS Cluster Endpoint
    Value: !GetAtt EKSCluster.Endpoint

  OIDCProviderArn:
    Description: OIDC Provider ARN
    Value: !GetAtt OIDCProvider.Arn
    Export:
      Name: !Sub '${AWS::StackName}-OIDCProviderArn'

  OIDCProviderUrl:
    Description: OIDC Provider URL
    Value: !GetAtt EKSCluster.OpenIdConnectIssuerUrl
    Export:
      Name: !Sub '${AWS::StackName}-OIDCProviderUrl'

  ClusterSecurityGroupId:
    Description: EKS Cluster Security Group ID (used by nodes)
    Value: !GetAtt EKSCluster.ClusterSecurityGroupId
    Export:
      Name: !Sub '${AWS::StackName}-ClusterSecurityGroupId'

  NodeRoleArn:
    Description: Node IAM Role ARN
    Value: !GetAtt EKSNodeRole.Arn
